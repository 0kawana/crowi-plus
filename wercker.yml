box: node:6.10

services:
  - mongo:3.4


test:
  steps:
    - script:
      name: set yarn cache-folder
      code: yarn config set cache-folder $WERCKER_CACHE_DIR/yarn

    - script:
      name: install dependencies
      code: |
        yarn global add npm@4
        yarn install

    - script:
      name: print dependencies
      code: yarn list --depth=0

    - script:
      name: npm test
      code: |
        export MONGO_URI=mongodb://$MONGO_PORT_27017_TCP_ADDR/crowi_test
        echo "export MONGO_URI=$MONGO_URI"
        npm test

    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      notify_on: "failed"


build-prod:
  steps:
    - script:
      name: set yarn cache-folder
      code: yarn config set cache-folder $WERCKER_CACHE_DIR/yarn

    - script:
      name: install dependencies
      code: |
        yarn global add npm@4
        yarn install --production

    - script:
      name: print dependencies
      code: yarn list --depth=0

    - script:
      name: npm run build:prod
      code: |
        npm run build:prod

    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      notify_on: "failed"


build-dev:
  steps:
    - script:
      name: set yarn cache-folder
      code: yarn config set cache-folder $WERCKER_CACHE_DIR/yarn

    - script:
      name: install dependencies
      code: |
        yarn global add npm@4
        yarn install

    - script:
      name: print dependencies
      code: yarn list --depth=0

    - script:
      name: npm run build:dev
      code: |
        npm run build:dev

    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      notify_on: "failed"


release: # would be run on release branch
  steps:
    - install-packages:
      packages: jq ruby

    - script:
      name: bump version
      code: |
        sh ./bin/wercker/init-git.sh
        # npm version to bump version
        npm version patch
        # get version
        RELEASE_VERSION=`npm run version --silent`
        echo "RELEASE_VERSION=$RELEASE_VERSION"

    - script:
      name: commit and push
      code: |
        TMP_RELEASE_BRANCH=tmp/release-$RELEASE_VERSION
        git checkout -B $TMP_RELEASE_BRANCH
        git push -u origin HEAD:$TMP_RELEASE_BRANCH
        TARGET_COMMITISH=`git rev-parse HEAD`

    - github-create-release:
      token: $GITHUB_TOKEN
      tag: v$RELEASE_VERSION
      target-commitish: $TARGET_COMMITISH

    - script:
      name: remove temporary release branch
      code: |
        git push --delete origin $TMP_RELEASE_BRANCH

    - script:
      name: trigger crowi-plus-docker release pipeline
      code: |
        sh ./bin/wercker/trigger-crowi-plus-docker.sh

    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      passed_message: :anchor: crowi-plus v$RELEASE_VERSION has been released!
